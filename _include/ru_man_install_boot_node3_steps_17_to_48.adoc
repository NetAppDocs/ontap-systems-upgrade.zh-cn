= 
:allow-uri-read: 


. 【 ｛ man_install3_step17]] 如果 node3 上安装的 ONTAP 版本与 node1 上安装的 ONTAP 9 版本相同或更高，请列出磁盘并将其重新分配给新的 node3 ：
+
`boot_ontap`

+

WARNING: 如果此新节点曾在任何其他集群或HA对中使用过、则必须运行 `wipeconfig` 然后继续。否则可能会导致服务中断或数据丢失。如果先前使用了替代控制器，请联系技术支持，尤其是在这些控制器运行的是在 7- 模式下运行的 ONTAP 时。

. 按 CTRL-C 显示启动菜单。
. [[man_install3_step19]] 执行以下操作之一：
+
[cols="35,65"]
|===
| 如果要升级的系统 ... | 那么 ... 


| node3 上的 ONTAP 版本是否正确或最新 | 前往<<man_install3_step13,第 13 步>>。 


| node3 上的 ONTAP 版本正确或最新 | 前往<<man_install3_step18,第 18 步>>。 
|===
. [[man_install3_step13]]通过选择以下操作之一来配置网络启动连接。
+

NOTE: 您必须使用管理端口和 IP 作为网络启动连接。请勿使用数据 LIF IP ，否则在执行升级期间可能会发生数据中断。

+
[cols="35,65"]
|===
| 动态主机配置协议（ DHCP ） | 那么 ... 


| 正在运行 | 在启动环境提示符处输入以下命令，以自动配置连接： `ifconfig e0M -auto` 


| 未运行  a| 
在启动环境提示符处输入以下命令、以手动配置连接：
`ifconfig e0M -addr=_filer_addr_ -mask=_netmask_ -gw=_gateway_ -dns=_dns_addr_ -domain=_dns_domain_`

`_filer_addr_` 是存储系统的IP地址(必填)。
`_netmask_` 是存储系统的网络掩码(必需)。
`_gateway_` 是存储系统的网关(必需)。
`_dns_addr_` 是网络上名称服务器的IP地址(可选)。
`_dns_domain_` 是域名服务(Domain Name Service、DNS)域名。如果使用此可选参数，则无需在网络启动服务器 URL 中使用完全限定域名；您只需要服务器的主机名。


NOTE: 您的接口可能需要其他参数。有关详细信息，请在固件提示符处输入 `help ifconfig` 。

|===
. 在节点 3 上执行网络启动：
+
[cols="35,65"]
|===
| 针对 ... | 那么 ... 


| FAS/AFF8000 系列系统 | `netboot \http://web_server_ip/path_to_webaccessible_directory/netboot/kernel` 


| 所有其他系统 | `netboot \http://web_server_ip/path_to_webaccessible_directory/ontap_version_image.tgz` 
|===
+
`path_to_the_web-accessible_directory` 会指向您下载 `ontap_version_image.tgz` 的位置 link:prepare_for_netboot.html#man_netboot_Step1["第 1 步"] 在 _prepare for netboot_ 一节中。

+

NOTE: 请勿中断启动。

. 从启动菜单中，首先选择选项*(7) 安装新软件*。
+
此菜单选项可下载新的 ONTAP 映像并将其安装到启动设备中。

+
请忽略以下消息：

+
`This procedure is not supported for Non-Disruptive Upgrade on an HA pair`

+
注意适用场景可无中断升级 ONTAP ，而不是升级控制器。

+

NOTE: 请始终使用 netboot 将新节点更新为所需映像。如果使用其他方法在新控制器上安装映像，则可能安装了错误的映像。此问题描述适用场景是 ONTAP 的所有版本。netboot操作步骤 与选项结合使用 `(7) Install new software` 擦除启动介质并将相同的ONTAP 版本ONTAP 放置在两个映像分区上。

. 如果提示您继续该过程，请输入 `y`，当提示输入包时，输入以下 URL：
+
` http://web_server_ip/path_to_web-accessible_directory/ontap_version_image.tgz`

. 完成以下子步骤：
+
.. 出现以下提示时，输入 `n` 以跳过备份恢复：
+
[listing]
----
Do you want to restore the backup configuration now? {y|n}
----
.. 出现以下提示时，输入 `y` 以重新启动：
+
[listing]
----
The node must be rebooted to start using the newly installed software. Do you want to reboot now? {y|n}
----
+
控制器模块重新启动，但停留在启动菜单处，因为启动设备已重新格式化，需要还原配置数据。



. [[man_install3_step18]]通过输入选择 *(5) 维护模式启动* `5` ，然后输入 `y`当提示继续启动时。
. 【 man_install3_step26]] 继续操作前，请转到 link:set_fc_uta_uta2_config_node3.html["在 node3 上设置 FC 或 UTA/UTA2 配置"] 对节点上的 FC 或 UTA/UTA2 端口进行任何必要的更改。
+
按照这些部分中的建议进行更改，重新启动节点并进入维护模式。

. 查找节点3的系统ID：
+
`d` 展示 -A

+
系统将显示节点的系统 ID 及其磁盘信息，如以下示例所示：

+
[listing]
----
 *> disk show -a
 Local System ID: 536881109
 DISK     OWNER                    POOL  SERIAL   HOME          DR
 HOME                                    NUMBER
 -------- -------------            ----- -------- ------------- -------------
 0b.02.23 nst-fas2520-2(536880939) Pool0 KPG2RK6F nst-fas2520-2(536880939)
 0b.02.13 nst-fas2520-2(536880939) Pool0 KPG3DE4F nst-fas2520-2(536880939)
 0b.01.13 nst-fas2520-2(536880939) Pool0 PPG4KLAA nst-fas2520-2(536880939)
 ......
 0a.00.0               (536881109) Pool0 YFKSX6JG              (536881109)
 ......
----
+

NOTE: 输入命令后，您可能会看到消息 `disk show ： no disks match option -a` 。此消息不是错误消息，因此您可以继续使用操作步骤。

. [[man_install3_step21]]重新分配节点 1 的备用磁盘、属于根的任何磁盘以及之前未重新定位到节点 2 的任何非根聚合link:relocate_non_root_aggr_node1_node2.html["将非根聚合从 node1 重新定位到 node2"]。
+
根据您的系统是否具有共享磁盘，输入 `disk reassign` 命令的适当格式：

+

NOTE: 如果系统上有共享磁盘、混合聚合或这两者、则必须使用正确的 `disk reassign` 下表中的命令。

+
[cols="35,65"]
|===
| 磁盘类型 | 然后运行命令 ... 


| 共享磁盘 | `dreassign -s _node1_sysid_-d _node3_sysid_-p _node2_sysid_` 


| 无共享磁盘 | `dreassign -s _node1_sysid_-d _node3_sysid_` 
|===
+
对于` node1_sysid_`值、请使用中捕获的信息 link:record_node1_information.html["记录 node1 信息"]。要获取` node3_sysid_`的值、请使用`ssysconfig`命令。

+

NOTE: 只有当存在共享磁盘时，才需要在维护模式下使用 ` -p` 选项。

+
`d` reassign`命令仅重新分配` node1_sysid_为其当前所有者的磁盘。

+
系统将显示以下消息：

+
[listing]
----
Partner node must not be in Takeover mode during disk reassignment from maintenance mode.
Serious problems could result!!
Do not proceed with reassignment if the partner is in takeover mode. Abort reassignment (y/n)?
----
. 【 man_install3_step29]] 输入 `n` 。
+
系统将显示以下消息：

+
[listing]
----
After the node becomes operational, you must perform a takeover and giveback of the HA partner node to ensure disk reassignment is successful.
Do you want to continue (y/n)?
----
. 【 man_install3_step30]] 输入 `y`
+
系统将显示以下消息：

+
[listing]
----
Disk ownership will be updated on all disks previously belonging to Filer with sysid <sysid>.
Do you want to continue (y/n)?
----
. 【 man_install3_step31]] 输入 `y` 。
. 【 ｛ man_install3_step32]] 如果要从具有外部磁盘的系统升级到支持内部和外部磁盘的系统（例如， AFF A800 系统），请将 node1 聚合设置为 root ，以确认 node3 从 node1 的根聚合启动。
+

WARNING: * 警告 * ：您必须按所示的确切顺序执行以下子步骤；否则可能发生原因会导致中断甚至数据丢失。

+
以下操作步骤会将 node3 设置为从 node1 的根聚合启动：

+
.. 检查 node1 聚合的 RAID ，丛和校验和信息：
+
`aggr status -r`

.. 检查 node1 聚合的状态：
+
`聚合状态`

.. 如果需要，将 node1 聚合置于联机状态：
+
`aggr_online _root_aggr_from_node1_`

.. 阻止node3从其原始根聚合启动：`aggr offline _root_aggr_on_node3_`
.. 将 node1 根聚合设置为 node3 的新根聚合：
+
`aggr options _aggr_from_node1_ root`

.. 验证 node3 的根聚合是否脱机，从 node1 接管的磁盘的根聚合是否联机并设置为 root ：
+
`聚合状态`

+

NOTE: 如果不执行上一个子步骤，发生原因 node3 可能会从内部根聚合启动，或者它可能会发生原因系统以假定存在新的集群配置或提示您确定一个集群配置。

+
下面显示了命令输出的示例：



+
[listing]
----
 ---------------------------------------------------------------
      Aggr State               Status          Options
 aggr0_nst_fas8080_15 online   raid_dp, aggr   root, nosnap=on
                               fast zeroed
                               64-bit

   aggr0 offline               raid_dp, aggr   diskroot
                               fast zeroed
                               64-bit
 ----------------------------------------------------------------------
----
. 【 man_install3_step33]] 验证控制器和机箱是否配置为 `ha` ：
+
`ha-config show`

+
以下示例显示了 ha-config show 命令的输出：

+
[listing]
----
 *> ha-config show
    Chassis HA configuration: ha
    Controller HA configuration: ha
----
+
系统会记录在可编程 ROM （ PROM ）中，无论是 HA 对还是独立配置。独立系统或 HA 对中的所有组件的状态都必须相同。

+
如果控制器和机箱未配置为 "ha" ，请使用以下命令更正配置：

+
`ha-config modify controller ha`

+
`ha-config modify chassis ha`

+
如果您使用的是 MetroCluster 配置，请使用以下命令修改控制器和机箱：

+
`ha-config modify controller mcc`

+
`ha-config modify chassis mcc`

. 【 man_install3_step34]] 销毁 node3 上的邮箱：
+
`m邮箱销毁本地`

+
控制台将显示以下消息：

+
[listing]
----
Destroying mailboxes forces a node to create new empty mailboxes, which clears any takeover state, removes all knowledge of out-of-date plexes of mirrored volumes, and will prevent management services from going online in 2-node cluster HA configurations. Are you sure you want to destroy the local mailboxes?
----
. 【 man_install3_step35]] 在提示符处输入 `y` 确认您要销毁本地邮箱。
. 【 man_install3_step36]] 退出维护模式：
+
`halt`

+
系统将在启动环境提示符处停止。

. 在 node2 上，检查系统日期，时间和时区：
+
`dATE`

. 【 ｛ man_install3_step38]] 在 node3 上，在启动环境提示符处检查日期：
+
`s如何选择日期`

. 【 man_install3_step39]] 如有必要，请在 node3 上设置日期：
+
`set date _MM/dd/yyy_`

. 在 node3 上，在启动环境提示符处检查时间：
+
`s时间`

. 【 man_install3_step41]] 如有必要，请在 node3 上设置时间：
+
`set time _hh：mm：ss_`

. [[man_install3_step42]]验证合作伙伴系统 ID 是否按照<<man_install3_step21,第 21 步>>在 -p 开关下：
+
`printenv partner-sysid`

. 如果需要，请在 node3 上设置配对系统 ID ：
+
`setenv partner-sysid _node2_sysid_`

+
保存设置：

+
`saveenv`

. 【 man_install3_step44]] 在启动环境提示符处访问启动菜单：
+
`boot_ontap 菜单`

. 在启动菜单中，输入 `6` 以选择选项 * （ 6 ） Update flash from backup config* 。
+
系统将显示以下消息：

+
[listing]
----
This will replace all flash-based configuration with the last backup to disks. Are you sure you want to continue?:
----
. 在提示符处输入 `y` 。
+
启动正常进行，然后系统会要求您确认系统 ID 不匹配。

+

NOTE: 系统可能会重新启动两次，然后才会显示不匹配警告。

. [[man_install3_step47]] 确认不匹配，如以下示例所示：
+
[listing]
----
WARNING: System id mismatch. This usually occurs when replacing CF or NVRAM cards!
Override system id (y|n) ? [n] y
----
+
节点可能会经过一轮重新启动，然后才能正常启动。

. 【 man_install3_step48]] 登录到 node3 。

